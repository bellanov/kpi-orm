[tox]
isolated_build = True
envlist = clean, py{39}, report, reportxml, reporthtml

[testenv]
setenv =
    PYTHONPATH={toxinidir}/src
    POWERTOOLS_TRACE_DISABLED=1
    PYTEST_ADDOPTS=--junit-prefix={envname} --junit-xml=coverage/junit.xml
    PIP_EXTRA_INDEX_URL=https://pypi.python.org/simple
    NUM_WORKERS=25
deps =
    coverage
    pytest
    mock
    flask
    functions_framework
    google-auth
    google-cloud-ndb
    pandas
    yfinance
    -rrequirements.txt
whitelist_externals = mkdir
commands =
    mkdir coverage/
    coverage run -p -m pytest -vv tests/

[testenv:lint]
deps =
    backoff
    functions_framework
    google-cloud-ndb
    google-auth
    yfinance
    pandas
    pytest
    pylint
commands =
    pylint --max-line-length=150 scripts/ src/ tests/

[testenv:format]
deps =
    backoff
    functions_framework
    google-cloud-ndb
    google-auth
    yfinance
    pandas
    pytest
    black
commands =
    black --line-length=150 scripts/ src/ tests/

[testenv:quickstart]
passenv = GOOGLE_APPLICATION_CREDENTIALS
deps =
    google-cloud-ndb
commands =
    python scripts/quickstart.py

[testenv:store_asset_data]
setenv = 
    NUM_WORKERS=25
passenv = GOOGLE_APPLICATION_CREDENTIALS
deps =
    google-cloud-ndb
    pandas
    yfinance
commands =
    python scripts/store_asset_data.py

[testenv:test_quickstart]
passenv = GOOGLE_APPLICATION_CREDENTIALS
deps =
    backoff
    pytest
    google-cloud-ndb
commands =
    pytest -vv scripts/

[testenv:pool]
passenv = GOOGLE_APPLICATION_CREDENTIALS
deps =
    backoff
    pytest
    google-cloud-ndb
commands =
    python scripts/worker_pool.py

[testenv:clean]
deps =
    coverage
    pytest
    mock
skip_install = true
envdir = {toxworkdir}/coverage
whitelist_externals = rm
commands =
    rm -rf dist/
    rm -rf coverage/
    coverage erase

[testenv:report]
deps = coverage
skip_install = true
envdir = {toxworkdir}/coverage
commands =
    coverage combine
    coverage report

[testenv:reporthtml]
deps = coverage
skip_install = true
envdir = {toxworkdir}/coverage
commands = coverage html --ignore-errors

[testenv:reportxml]
deps = coverage
skip_install = true
envdir = {toxworkdir}/coverage
commands = coverage xml --ignore-errors -o coverage/coverage.xml

[testenv:build]
skip_install = true
deps = build
commands =
    python -m build

[testenv:release]
deps =
    twine
skip_install = true
commands =
    {[testenv:build]commands}
    twine upload --skip-existing dist/*.*